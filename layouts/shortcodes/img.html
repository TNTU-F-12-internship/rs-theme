{{- $alt := .Get "alt" -}}
{{- $res := resources.Get (.Get "src") -}}

{{- $ws := slice 480 768 1366 1920 -}}
{{- $srcset := slice -}}
{{- range $ws -}}
    {{/* to avoid creating an image that is larger than the source */}}
    {{- if (le . $res.Width) -}}
        {{- $w := printf "%dx" . -}}
        {{- $url := ($res.Resize $w).RelPermalink | safeURL -}}
        {{- $fmt := printf "%s %dw" $url . -}}
        {{- $srcset = $srcset | append $fmt -}}
    {{- end -}}
{{- end -}}

{{/* to avoid empty srcset when image is too small */}}
{{- $src_count := len $srcset -}}
{{- if eq $src_count 0 -}}
    {{- $w := $res.Width -}}
    {{- $url := $res.RelPermalink | safeURL -}}
    {{- $fmt := printf "%s %dw" $url $w -}}
    {{- $srcset = $srcset | append $fmt -}}
{{- end -}}

{{- $set := delimit $srcset "," -}}

<figure>
    <img
        srcset="{{ $set }}"
        sizes="(max-width: 480px) 480px, 100vw"
        src="{{ $res.RelPermalink }}"
        alt="{{ $alt }}"
    >
    {{- if .Params.alt -}}
    <figcaption>{{ $alt }}</figcaption>
    {{- end -}}
</figure>
